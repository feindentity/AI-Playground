<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedgehog the Sonnet Helper</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-serif {
            font-family: 'Crimson Text', serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5f5f4;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d6d3d1;
            border-radius: 20px;
        }
    </style>
</head>

<body class="bg-stone-100 text-stone-800 selection:bg-amber-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVGs to replace lucide-react) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>;
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></IconBase>;

        // --- Syllable Counting Logic (Heuristic) ---
        const countSyllables = (text) => {
            if (!text) return 0;
            const words = text.toLowerCase().replace(/[^a-z ]/g, '').split(' ').filter(w => w.length > 0);

            let totalSyllables = 0;

            words.forEach(word => {
                if (word.length <= 3) {
                    totalSyllables += 1;
                    return;
                }
                let core = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
                core = core.replace(/^y/, '');
                const vowels = core.match(/[aeiouy]{1,2}/g);
                totalSyllables += vowels ? vowels.length : 1;
            });

            return totalSyllables;
        };

        // --- Sonnet Configuration Data ---
        const MODES = {
            shakespearean: {
                name: "Shakespearean",
                scheme: ['A', 'B', 'A', 'B', 'C', 'D', 'C', 'D', 'E', 'F', 'E', 'F', 'G', 'G'],
                labels: {
                    0: "Quatrain 1", 4: "Quatrain 2", 8: "Quatrain 3", 12: "Couplet"
                },
                description: "AB-AB CD-CD EF-EF GG",
                guide: [
                    { letter: 'A', color: 'text-amber-600' }, { letter: 'B', color: 'text-blue-600' },
                    { letter: 'C', color: 'text-green-600' }, { letter: 'D', color: 'text-purple-600' },
                    { letter: 'E', color: 'text-red-600' }, { letter: 'F', color: 'text-orange-600' },
                    { letter: 'G', color: 'text-stone-800' }
                ]
            },
            petrarchan: {
                name: "Petrarchan",
                scheme: ['A', 'B', 'B', 'A', 'A', 'B', 'B', 'A', 'C', 'D', 'E', 'C', 'D', 'E'],
                labels: {
                    0: "The Octave", 8: "The Sestet"
                },
                description: "ABBA-ABBA CDE-CDE",
                guide: [
                    { letter: 'A', color: 'text-amber-600' }, { letter: 'B', color: 'text-blue-600' },
                    { letter: 'C', color: 'text-green-600' }, { letter: 'D', color: 'text-purple-600' },
                    { letter: 'E', color: 'text-red-600' }
                ]
            }
        };

        function SonnetHelper() {
            const [mode, setMode] = useState('shakespearean');
            const [text, setText] = useState("");
            const [currentLineIndex, setCurrentLineIndex] = useState(0);
            const [rhymeQuery, setRhymeQuery] = useState("");
            const [rhymeResults, setRhymeResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [showInfo, setShowInfo] = useState(false);
            const [showExport, setShowExport] = useState(false);

            const textareaRef = useRef(null);
            const currentConfig = MODES[mode];

            // Parse lines dynamically
            const lines = text.split('\n');

            // Ensure we usually treat it as 14 lines for the UI, filling gaps if needed
            const displayLines = Array(14).fill("").map((_, i) => lines[i] || "");

            // Update cursor position tracking
            const handleTextChange = (e) => {
                setText(e.target.value);
                updateCurrentLine(e.target);
            };

            const handleSelect = (e) => {
                updateCurrentLine(e.target);
            };

            const updateCurrentLine = (element) => {
                const cursorPos = element.selectionStart;
                const textBefore = element.value.substr(0, cursorPos);
                const lineIndex = textBefore.split('\n').length - 1;
                setCurrentLineIndex(Math.min(lineIndex, 13)); // Cap at 13 for stats
            };

            // Fetch rhymes
            const searchRhymes = async (e) => {
                e.preventDefault();
                if (!rhymeQuery) return;
                setIsSearching(true);
                try {
                    const response = await fetch(`https://api.datamuse.com/words?rel_rhy=${rhymeQuery}&max=20`);
                    const data = await response.json();
                    setRhymeResults(data);
                } catch (error) {
                    console.error("Failed to fetch rhymes", error);
                }
                setIsSearching(false);
            };

            // Export functions
            const downloadTxt = () => {
                const element = document.createElement("a");
                const file = new Blob([text], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = `${mode}_sonnet.txt`;
                document.body.appendChild(element);
                element.click();
                setShowExport(false);
            };

            const downloadJson = () => {
                const data = JSON.stringify({
                    title: "My Sonnet",
                    type: mode,
                    content: text,
                    lines: lines,
                    scheme: currentConfig.scheme
                }, null, 2);
                const element = document.createElement("a");
                const file = new Blob([data], { type: 'application/json' });
                element.href = URL.createObjectURL(file);
                element.download = `${mode}_sonnet.json`;
                document.body.appendChild(element);
                element.click();
                setShowExport(false);
            };

            // Get current line stats
            const currentLineText = displayLines[currentLineIndex] || "";
            const currentSyllables = countSyllables(currentLineText);
            const currentTarget = currentConfig.scheme[currentLineIndex];
            const currentLabel = Object.keys(currentConfig.labels).reduce((prev, curr) => {
                return parseInt(curr) <= currentLineIndex ? currentConfig.labels[curr] : prev;
            }, "");

            return (
                <div className="min-h-screen flex flex-col">

                    {/* Compact Header */}
                    <header className="bg-amber-900 text-amber-50 p-2 shadow-sm z-20 flex-shrink-0">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-amber-100 w-8 h-8 flex items-center justify-center rounded-full shadow-inner border border-amber-800 text-lg">
                                    ðŸ¦”
                                </div>
                                <div className="hidden sm:block">
                                    <h1 className="text-sm font-bold font-serif tracking-wide text-amber-100">Sonnet Helper</h1>
                                </div>
                            </div>

                            <div className="flex items-center gap-2">
                                <div className="flex items-center bg-amber-950/40 p-0.5 rounded border border-amber-800/50">
                                    <button
                                        onClick={() => setMode('shakespearean')}
                                        className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${mode === 'shakespearean' ? 'bg-amber-100 text-amber-900 shadow' : 'text-amber-400'}`}
                                    >
                                        Shak
                                    </button>
                                    <button
                                        onClick={() => setMode('petrarchan')}
                                        className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${mode === 'petrarchan' ? 'bg-amber-100 text-amber-900 shadow' : 'text-amber-400'}`}
                                    >
                                        Petr
                                    </button>
                                </div>

                                <button onClick={() => setShowInfo(true)} className="p-1.5 hover:bg-amber-800 rounded transition-colors text-amber-200">
                                    <Info size={18} />
                                </button>
                                <button onClick={() => setShowExport(true)} className="p-1.5 hover:bg-amber-800 rounded transition-colors text-amber-200">
                                    <Save size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <div className="flex-1 max-w-4xl mx-auto w-full p-2 md:p-4 flex flex-col md:flex-row gap-4 overflow-hidden">

                        {/* Left Column: Editor & Status */}
                        <div className="flex-1 flex flex-col min-h-0 bg-white rounded-xl shadow border border-stone-200">

                            {/* Live Status Bar (Sticky Top of Editor) */}
                            <div className="bg-stone-50 border-b border-stone-200 p-2 flex items-center justify-between text-xs md:text-sm">
                                <div className="font-bold text-amber-800 flex items-center gap-2">
                                    <span className="bg-amber-100 px-1.5 py-0.5 rounded text-[10px] uppercase border border-amber-200">Line {currentLineIndex + 1}</span>
                                    <span className="hidden sm:inline">{currentLabel}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center gap-1" title="Rhyme Scheme">
                                        <span className="text-stone-400 uppercase text-[10px]">Rhyme</span>
                                        <span className="font-bold font-serif bg-stone-200 w-5 h-5 flex items-center justify-center rounded text-stone-700">{currentTarget}</span>
                                    </div>
                                    <div className={`flex items-center gap-1 font-bold transition-colors ${currentSyllables === 10 ? 'text-green-600' :
                                        currentSyllables > 10 ? 'text-red-500' : 'text-amber-600'
                                        }`}>
                                        <span>{currentSyllables}</span>
                                        <span className="text-[10px] uppercase font-normal text-stone-400">Syl</span>
                                        {currentSyllables === 10 && <CheckCircle2 size={12} />}
                                    </div>
                                </div>
                            </div>

                            {/* The Parchment (Single Text Area) */}
                            <textarea
                                ref={textareaRef}
                                value={text}
                                onChange={handleTextChange}
                                onSelect={handleSelect}
                                onClick={handleSelect}
                                onKeyUp={handleSelect}
                                placeholder="Shall I compare thee to a summer's day?..."
                                className="flex-1 w-full p-4 resize-none outline-none font-serif text-lg leading-relaxed text-stone-800 bg-transparent placeholder-stone-300"
                                spellCheck="false"
                            />

                            {/* Structure Grid (Visual Overview) */}
                            <div className="border-t border-stone-100 bg-stone-50 p-2 overflow-x-auto">
                                <div className="flex justify-between md:justify-start md:gap-2 min-w-max px-1">
                                    {currentConfig.scheme.map((schemeChar, i) => {
                                        const lineText = displayLines[i] || "";
                                        const syl = countSyllables(lineText);
                                        const isActive = i === currentLineIndex;
                                        const statusColor = !lineText ? 'bg-stone-100 border-stone-200 text-stone-300' :
                                            syl === 10 ? 'bg-green-100 border-green-300 text-green-700' :
                                                syl > 10 ? 'bg-red-50 border-red-200 text-red-600' :
                                                    'bg-amber-50 border-amber-200 text-amber-600';

                                        return (
                                            <div
                                                key={i}
                                                className={`
                                                    w-6 h-6 md:w-8 md:h-8 rounded-md flex items-center justify-center text-[10px] md:text-xs font-bold border transition-all relative
                                                    ${statusColor}
                                                    ${isActive ? 'ring-2 ring-amber-400 ring-offset-1 z-10 scale-110 shadow-sm' : ''}
                                                `}
                                                title={`Line ${i + 1}: Needs rhyme ${schemeChar}`}
                                            >
                                                {schemeChar}
                                                {/* Tiny dot for content existence */}
                                                {lineText && (
                                                    <div className={`absolute -bottom-1 w-1 h-1 rounded-full ${syl === 10 ? 'bg-green-500' : 'bg-amber-400'}`}></div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Rhyme Tools */}
                        <div className="w-full md:w-64 flex-shrink-0 flex flex-col gap-4">
                            <div className="bg-white rounded-xl shadow border border-stone-200 overflow-hidden flex flex-col h-48 md:h-auto md:flex-1 min-h-[200px]">
                                <div className="bg-amber-50 p-3 border-b border-amber-100">
                                    <h3 className="font-bold text-amber-900 text-sm flex items-center gap-2">
                                        <Search size={14} />
                                        Rhyme Finder
                                    </h3>
                                </div>

                                <div className="p-3 flex-1 flex flex-col min-h-0">
                                    <form onSubmit={searchRhymes} className="relative mb-3">
                                        <input
                                            type="text"
                                            value={rhymeQuery}
                                            onChange={(e) => setRhymeQuery(e.target.value)}
                                            placeholder="Word..."
                                            className="w-full p-2 pr-8 text-sm rounded border border-stone-300 focus:border-amber-500 outline-none"
                                        />
                                        <button type="submit" className="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400">
                                            {isSearching ? "..." : <Search size={14} />}
                                        </button>
                                    </form>

                                    <div className="flex-1 overflow-y-auto pr-1 custom-scrollbar">
                                        {rhymeResults.length > 0 ? (
                                            <div className="flex flex-wrap gap-1.5">
                                                {rhymeResults.map((item, i) => (
                                                    <button
                                                        key={i}
                                                        onClick={() => navigator.clipboard.writeText(item.word)}
                                                        className="px-2 py-1 bg-stone-50 hover:bg-amber-50 border border-stone-100 rounded text-xs text-stone-600 hover:text-amber-900"
                                                    >
                                                        {item.word}
                                                    </button>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center text-stone-300 text-xs italic">
                                                Type a word to find rhymes
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Info Modal */}
                    {showInfo && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                                <div className="p-4 border-b border-stone-100 flex justify-between items-center bg-white sticky top-0">
                                    <h2 className="font-bold text-amber-900">Sonnet Rules</h2>
                                    <button onClick={() => setShowInfo(false)}><X size={20} className="text-stone-400" /></button>
                                </div>
                                <div className="p-4 space-y-4 text-sm text-stone-600">
                                    <p>This mode ({currentConfig.name}) follows the structure: <strong>{currentConfig.description}</strong>.</p>
                                    <div className="bg-stone-50 p-3 rounded text-xs font-mono">
                                        {currentConfig.guide.map(g => (
                                            <span key={g.letter} className={`mr-3 font-bold ${g.color}`}>{g.letter}</span>
                                        ))}
                                    </div>
                                    <p>Aim for 10 syllables per line (Iambic Pentameter).</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Export Modal */}
                    {showExport && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-xl max-w-xs w-full">
                                <div className="p-4 border-b border-stone-100 flex justify-between items-center">
                                    <h2 className="font-bold text-stone-800">Export</h2>
                                    <button onClick={() => setShowExport(false)}><X size={20} className="text-stone-400" /></button>
                                </div>
                                <div className="p-4 space-y-2">
                                    <button onClick={downloadTxt} className="w-full p-3 bg-stone-50 hover:bg-amber-50 rounded border border-stone-200 text-left text-sm font-bold text-stone-700 flex items-center gap-2">
                                        <FileText size={16} /> Plain Text (.txt)
                                    </button>
                                    <button onClick={downloadJson} className="w-full p-3 bg-stone-50 hover:bg-amber-50 rounded border border-stone-200 text-left text-sm font-bold text-stone-700 flex items-center gap-2">
                                        <div className="font-mono text-[10px] bg-stone-200 px-1 rounded">{'{}'}</div> JSON Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SonnetHelper />);
    </script>
</body>

</html>